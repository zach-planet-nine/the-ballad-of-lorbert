using System;
using System.Collections;
using System.Collections.Generic;
using UnityEngine;
using Cryptography.ECDSA;
using System.Text;

public class NineumManager : MonoBehaviour
{
    public static NineumManager manager;
    private List<string> Nineum = new List<string>();
    private User user;
    private NetworkManager nm;

    private void Awake()
    {
        /*string userJSON = "{\"userId\":2,\"name\":\"beer - foo - beer\",\"locationId\":5,\"powerId\":13,\"powerOrdinal\":6,\"power\":0,\"lastPowerUsed\":\"2018 - 08 - 18T00: 17:40.019Z\",\"powerRegenerationRate\":1.666667,\"globalRegenerationRate\":1.666667,\"moveOrdinal\":10,\"lastMove\":\"2018 - 08 - 18T00: 38:52.609Z\",\"publicKey\":\"0277cf1e4adc7b4de93a9a3cd447b8b2a824f7da9b35c697cc2a1f7c6338694302\",\"publicKeySuspended\":false,\"keys\":{},\"location\":\"5\",\"exits\":{\"north\":2,\"south\":8,\"east\":14,\"west\":23,\"up\":6,\"down\":4},\"nineum\":[\"01000000010102030405060100000001\",\"01000000010101030108040100000001\",\"01000000010105030107070100000001\",\"01000000010201010406020100000001\",\"01000000010105040708060100000001\",\"01000000010102040506020100000001\",\"01000000010202090601010100000001\",\"01000000010202050401010100000001\",\"01000000010102020803020100000001\",\"01000000010206010208050100000001\",\"01000000010202020107080100000001\",\"01000000010104040603050100000001\"],\"currentPower\":2148,\"nextMove\":\"2019 - 11 - 12T17: 41:04.433Z\"}";

        User user = JsonUtility.FromJson<User>(userJSON);

        Debug.Log("The user has " + user.nineum.Count + " Nineum.");

        string signature = CryptoManager.signMessage("This is a message");

        Debug.Log(signature);*/

        //Nineum = new List<string> { "01000000010201060602030100000001", "01000000010201060602060100000001", "01000000010203060304080100000001", "01000000010204060506040100000001", "01000000010101060506080100000001", "01000000010201060301080100000001", "01000000010106060501040100000001", "01000000010204060208010100000001", "01000000010204060104030100000001", "01000000010202060405050100000001", "01000000010101060304050100000002", "01000000010204060806070100000001", "01000000010106060204030100000001", "01000000010202060608060100000002", "01000000010105060608060100000001", "01000000010101060801060100000001", "01000000010206060307060100000001", "01000000010102060506040100000001", "01000000010106020803080100000001", "01000000010104020305060100000001", "01000000010102090208040100000001", "01000000010101090301040100000001", "01000000010103090406010100000001", "01000000010206020806050100000001", "01000000010102010507070100000001", "01000000010202010605050100000001", "01000000010203020302050100000001", "01000000010204010201050100000001", "01000000010201010605010100000002", "01000000010105030208040100000001", "01000000010106010507010100000002", "01000000010201010507060100000001", "01000000010103010204060100000001", "01000000010102020304060100000001", "01000000010102060806080100000001", "01000000010201090408080100000001", "01000000010204010505010100000001", "01000000010103090505050100000001", "01000000010101090606020100000001", "01000000010102020202030100000001", "01000000010206010407040100000001", "01000000010105010306070100000001", "01000000010103090805070100000002", "01000000010206060406070100000001", "01000000010201020408060100000001", "01000000010105090105070100000001", "01000000010206090608030100000001", "01000000010106020306060100000001", "01000000010201030501050100000001", "01000000010206030408010100000001", "01000000010202010706080100000001", "01000000010103020203050100000001", "01000000010102040103050100000001", "01000000010201010401070100000001", "01000000010205010803080100000001", "01000000010201090603010100000001", "01000000010201020805020100000001", "01000000010105020102060100000001", "01000000010101010303020100000001", "01000000010202010807060100000001", "01000000010103020404040100000001", "01000000010204020303070100000001", "01000000010203020602010100000001", "01000000010206010704010100000001", "01000000010201040707070100000001", "01000000010105010603070100000001", "01000000010102020704010100000001", "01000000010203020307010100000001", "01000000010105040407050100000001", "01000000010103030205020100000001", "01000000010205020708070100000001", "01000000010201010801070100000001", "01000000010105050204010100000001", "01000000010105090605060100000001", "01000000010103040807080100000001", "01000000010103010505020100000001", "01000000010202020601060100000001", "01000000010206010706080100000001", "01000000010202010502020100000001", "01000000010102010805020100000001", "01000000010206040107010100000001", "01000000010105010603070100000002", "01000000010106040204060100000001", "01000000010104010803040100000001", "01000000010203090308060100000001", "01000000010205010803080100000002", "01000000010206090208020100000001", "01000000010101050802070100000001", "01000000010202010203050100000001", "01000000010103010202060100000001", "01000000010203020508020100000001", "01000000010205010607020100000001", "01000000010105010607050100000001", "01000000010205010808030100000002", "01000000010102010305010100000001", "01000000010101030106060100000001", "01000000010201020403030100000001", "01000000010102010303080100000001", "01000000010106040304080100000001", "01000000010204090804080100000001", "01000000010102010504010100000001", "01000000010206010103060100000001", "01000000010201030104080100000001", "01000000010102010707010100000001", "01000000010101030703050100000001", "01000000010103010402010100000002", "01000000010104010102060100000001", "01000000010101090305050100000001", "01000000010102010608060100000001", "01000000010106040503080100000001", "01000000010202010707030100000001", "01000000010201010608080100000001", "01000000010202090101060100000001", "01000000010202010605020100000001", "01000000010102010608080100000001", "01000000010205020103060100000002", "01000000010106010105050100000001", "01000000010203010807020100000002", "01000000010106010402080100000001", "01000000010206010408030100000001", "01000000010202010307020100000001", "01000000010201010601070100000001", "01000000010106010106040100000001", "01000000010105020607030100000001", "01000000010205010503020100000001", "01000000010204050707030100000001", "01000000010106020706050100000001", "01000000010101090707030100000001", "01000000010206090604050100000001", "01000000010101030106040100000001", "01000000010206030208060100000001", "01000000010106010302030100000001", "01000000010104010704080100000001", "01000000010203020806050100000001", "01000000010204090504080100000001", "01000000010206090303030100000001", "01000000010104040705050100000001", "01000000010201010706060100000002" };

        /*AddNineum("01000000010201010102030100000001");
        AddNineum("01000000010201010102060100000001");
        AddNineum("01000000010203010104080100000001");*/

        if (manager == null)
        {
            manager = this;
            DontDestroyOnLoad(gameObject);
        } else if(this != manager)
        {
            Destroy(gameObject);
        }
    }

    private void Start()
    {
        nm = GetComponent<NetworkManager>();
    }

    public void AddNineum(string ninea)
    {
        Nineum.Add(ninea);
        CharacterStats.characterStats.Nineum = Nineum;
    }

    public string GetNineumForEquipLocationAtIndex(EquipLocations location, int index)
    {
        return Nineum[0];
    }

    public List<string> GetNineum()
    {
        return Nineum;
    }

    public void ConnectUser(int userId)
    {
        Debug.Log("Connecting user");
        //RefreshNineum(userId);
    }

    /*public void RefreshNineum(int userId)
    {
        GatewayTimestampTuple gateway = new GatewayTimestampTuple("TheBalladOfLorbertTest");
        GatewayTimestampTupleWithSignature gatewayWithSignature = new GatewayTimestampTupleWithSignature(gateway, CryptoManager.signMessage(JsonUtility.ToJson(gateway)));

        Debug.Log("Refreshing user");

        

        nm.RefreshUser(userId, gatewayWithSignature, (err, resp) =>
        {
            if(err != null)
            {
                Debug.Log("ERRORRRORORRR!!!");
                Debug.Log(err);
                return;
            }
            user = JsonUtility.FromJson<User>(resp);
            Nineum = user.nineum;
            CharacterStats.characterStats.Nineum = Nineum;
            CharacterStats.characterStats.partyData.user = user;
            PlayerPrefs.SetInt("userId", user.userId);
        });
    }*/

    public void RefreshNineum(List<string> nineum)
    {
        Nineum = nineum;
    }

}

[Serializable]
public class User
{
    public int userId;
    public string name;
    public int locationId;
    public int powerId;
    public int powerOrdinal;
    public int power;
    public string lastPowerUsed;
    public float powerRegenerationRate;
    public float globalRegenerationRate;
    public int moveOrdinal;
    public string lastMove;
    public string publicKey;
    public Dictionary<string, string> keys;
    public int location;
    public Dictionary<string, int> exits;
    public List<string> nineum;
    public int currentPower;
    public string nextMove;
}
